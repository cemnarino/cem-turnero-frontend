<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestión de Consultorios – CEM Nariño</title>
    <!-- CSS Modular -->
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/consultorios.css" />
    <link rel="stylesheet" href="css/pacientes.css" />
    <link rel="stylesheet" href="css/turnos.css" />
    <link rel="stylesheet" href="css/historial.css" />
    <link rel="stylesheet" href="css/informante.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet" />
    <script>
      // Asegura que el DOM esté listo
      document.addEventListener('DOMContentLoaded', () => {
        // Activa Consultorios al arrancar
        document.querySelector('.tab[data-target="consultorios-view"]').click();
      });
    </script>
  </head>
  <body>
    <header class="main-navbar">
      <h1>Centro Médico de Especialistas de Nariño - CEM - Nariño</h1>
    </header>

    <!-- Sidebar -->
    <!-- Menú de pestañas (siempre visible) -->
    <nav class="tab-bar">
      <button class="tab active" data-target="consultorios-view">
        Consultorios
      </button>
      <button class="tab" data-target="pacientes-view">Pacientes</button>
      <button class="tab" data-target="turnos-view">Turnos</button>
      <button class="tab" data-target="historial-view">Historial</button>
      <button class="tab" data-target="informante-view">Informante</button>
    </nav>

    <!-- Overlay para cerrar en móviles/TV -->
    <div id="overlay" class="overlay"></div>

    <!-- Contenedor dinámico: cada sección se mostrará/ocultará según el hash -->
    <main id="main-content">
      <!-- ====== Consultorios ====== -->
      <section id="consultorios-view" class="view">
        <h1>Gestión de Consultorios</h1>

        <!-- Sección FORMULARIO -->
        <section id="consultorio-form-section">
          <form id="consultorioForm">
            <h2 id="formTitle">Nuevo Consultorio</h2>

            <label>
              Consultorio <span class="required">*</span>
              <select id="consultorio" name="consultorio" required>
                <option value="">Seleccione...</option>
                <option value="Consultorio 1">Consultorio 1</option>
                <option value="Consultorio 2">Consultorio 2</option>
                <option value="Laboratorio">Laboratorio</option>
              </select>
            </label>

            <label>
              Nombre del Médico <span class="required">*</span>
              <input type="text" id="nombre_medico" name="nombre_medico" required />
            </label>

            <label>
              Piso <span class="required">*</span>
              <select id="piso" name="piso" required>
                <option value="">Seleccione...</option>
                <option value="Piso 1">Piso 1</option>
                <option value="Piso 2">Piso 2</option>
                <option value="Piso 3">Piso 3</option>
                <option value="Piso 4">Piso 4</option>
                <option value="Piso 5">Piso 5</option>
                <option value="Planta Baja">Planta Baja</option>
              </select>
            </label>

            <div class="form-note">
              <i class="material-icons">info</i>
              <span>Todos los campos son obligatorios para crear un consultorio.</span>
            </div>

            <div class="form-actions">
              <button type="submit" id="btnGuardar">Guardar</button>
              <button type="button" id="btnCancelar" style="display: none">
                Cancelar
              </button>
            </div>
          </form>
        </section>

        <!-- Sección LISTADO -->
        <section id="consultorio-list-section">
          <h2>Listado de Consultorios</h2>

          <div class="search-container">
            <input
              type="text"
              id="filterInput"
              placeholder="Buscar consultorio..." />
          </div>

          <table id="consultorioTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Médico</th>
                <th>Consultorio</th>
                <th>Piso</th>
                <th>Turno Actual</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div id="noData" style="display: none">
            No se encontraron resultados.
          </div>
        </section>
      </section>

      <!-- ====== Pacientes ====== -->
      <section id="pacientes-view" class="view">
        <h1>Gestión de Pacientes</h1>

        <section id="paciente-form-section">
          <form id="pacienteForm">
            <h2 id="pacienteFormTitle">Nuevo Paciente</h2>

            <!-- Botones de acción superior -->
            <div class="top-actions">
              <button type="button" id="btnVerAgenda" class="btn-secondary">
                <i class="material-icons">calendar_today</i>
                Ver Agenda
              </button>
            </div>

            <!-- DATOS DE IDENTIFICACIÓN -->
            <fieldset>
              <legend>Datos de Identificación</legend>
              
              <div class="form-row">
                <label>
                  Tipo de Documento
                  <select id="tipo_documento" name="tipo_documento">
                    <option value="CEDULA">Cédula de Ciudadanía</option>
                    <option value="TI">Tarjeta de Identidad</option>
                    <option value="CE">Cédula de Extranjería</option>
                    <option value="PPT">Permiso de Protección Temporal</option>
                    <option value="PERMISO_TURISMO">Permiso de Turismo</option>
                  </select>
                </label>

                <label>
                  Número de Documento <span class="required">*</span>
                  <div class="cedula-input-group">
                    <input
                      type="text"
                      id="numero_documento"
                      name="numero_documento"
                      pattern="^[0-9A-Za-z]{6,15}$"
                      placeholder="Ingrese el número"
                      maxlength="15"
                      minlength="6"
                      required />
                    <button
                      type="button"
                      id="btnBuscarCedula"
                      class="search-btn"
                      title="Buscar historial">
                      <i class="material-icons">search</i>
                    </button>
                  </div>
                </label>
              </div>

              <!-- Resultados de la búsqueda por cédula -->
              <div
                id="resultadosBusquedaCedula"
                class="busqueda-resultados"
                style="display: none">
                <!-- Se llenará dinámicamente -->
              </div>

              <div class="form-row">
                <label>
                  Primer Nombre <span class="required">*</span>
                  <input
                    type="text"
                    id="primer_nombre"
                    name="primer_nombre"
                    required />
                </label>
                <label>
                  Segundo Nombre
                  <input type="text" id="segundo_nombre" name="segundo_nombre" />
                </label>
              </div>

              <div class="form-row">
                <label>
                  Primer Apellido <span class="required">*</span>
                  <input
                    type="text"
                    id="primer_apellido"
                    name="primer_apellido"
                    required />
                </label>
                <label>
                  Segundo Apellido
                  <input type="text" id="segundo_apellido" name="segundo_apellido" />
                </label>
              </div>

              <div class="form-row">
                <label>
                  Contacto (Teléfono)
                  <input
                    type="text"
                    id="contacto"
                    name="contacto"
                    pattern="^[0-9]{7,10}$"
                    placeholder="3001234567"
                    maxlength="10" />
                </label>
              </div>
            </fieldset>

            <!-- SEGURIDAD SOCIAL -->
            <fieldset>
              <legend>Seguridad Social</legend>
              <div class="form-row">
                <label>
                  EPS
                  <input type="text" id="eps" name="eps" placeholder="Ej: Salud Total" />
                </label>
                <label>
                  AFP
                  <input type="text" id="afp" name="afp" placeholder="Ej: Porvenir" />
                </label>
                <label>
                  ARL
                  <input type="text" id="arl" name="arl" placeholder="Ej: Positiva" />
                </label>
              </div>
            </fieldset>

            <!-- INFORMACIÓN LABORAL -->
            <fieldset>
              <legend>Información Laboral</legend>
              <div class="form-row">
                <label>
                  Empresa <span class="required">*</span>
                  <input
                    type="text"
                    id="empresa"
                    name="empresa"
                    placeholder="Nombre de la empresa"
                    required />
                </label>
                <label>
                  Cargo
                  <input
                    type="text"
                    id="cargo"
                    name="cargo"
                    placeholder="Ej: Operario" />
                </label>
              </div>

              <div class="form-row">
                <label>
                  Responsable de Empresa (Quien agenda)
                  <input
                    type="text"
                    id="responsable_empresa"
                    name="responsable_empresa"
                    placeholder="Nombre de quien solicita la cita" />
                </label>
              </div>
            </fieldset>

            <!-- INFORMACIÓN DEL EXAMEN -->
            <fieldset>
              <legend>Información del Examen</legend>
              
              <label>
                Tipo de Examen <span class="required">*</span>
                <select id="tipo_examen" name="tipo_examen" required>
                  <option value="">Seleccione...</option>
                  <option value="CONSULTA GENERAL">CONSULTA GENERAL</option>
                  <option value="LABORATORIO">LABORATORIO</option>
                  <option value="EXAMEN_INGRESO">Examen médico ocupacional de ingreso o preocupacional</option>
                  <option value="EXAMEN_PERIODICO">Examen médico ocupacional periódico</option>
                  <option value="EXAMEN_EGRESO">Examen ocupacional de Egreso</option>
                  <option value="EXAMEN_ALTURAS">Examen médico con énfasis en alturas</option>
                  <option value="MANIPULADORES_ALIMENTOS">Examen médico para manipuladores de alimentos</option>
                  <option value="POST_INCAPACIDAD">Exámenes médicos post incapacidad</option>
                  <option value="TRABAJO_SEGURO_CONDUCTORES">Examen médico de trabajo seguro para conductores</option>
                  <option value="TRABAJOS_ALTURA">Evaluación médica para trabajos en altura</option>
                  <option value="AUDIOMETRIA">Audiometría tamizaje ocupacional</option>
                  <option value="TAMIZAJE_VISUAL">Tamizaje visual</option>
                  <option value="OPTOMETRIA">Optometría ocupacional</option>
                  <option value="VISIOMETRIA">Visiometría</option>
                  <option value="FRAMINGHAM">Test de framingham</option>
                  <option value="RIESGO_CARDIOVASCULAR">Valoración del riesgo cardiovascular para trabajadores</option>
                  <option value="PSICOACTIVAS">Prueba cualitativa de sustancias psicoactivas</option>
                  <option value="ELECTROCARDIOGRAMA">Electrocardiograma</option>
                  <option value="ESPIROMETRIA">Espirometría ocupacional</option>
                  <option value="BATERIA_PSICOSOCIAL">Aplicación de batería riesgo psicosocial</option>
                  <option value="PSICOLOGIA">Consulta de psicología</option>
                  <option value="MEDICINA_GENERAL">Consulta de medicina general</option>
                </select>
              </label>

              <label>
                Observación (Información adicional)
                <textarea
                  id="observacion"
                  name="observacion"
                  rows="3"
                  placeholder="Información adicional sobre el examen a realizar"></textarea>
              </label>

              <div class="form-row">
                <label>
                  Valor (V/R)
                  <input
                    type="number"
                    id="valor"
                    name="valor"
                    min="0"
                    step="1000"
                    placeholder="0"
                    value="0" />
                </label>

                <label>
                  Hora Agendada (Opcional)
                  <input
                    type="datetime-local"
                    id="hora_agendada"
                    name="hora_agendada"
                    title="Si agenda con anticipación, seleccione fecha y hora" />
                </label>
              </div>

              <label>
                Consultorio <span class="required">*</span>
                <select id="consultorio_id" name="consultorio_id" required>
                  <option value="">Cargando...</option>
                </select>
              </label>
            </fieldset>

            <div class="form-note">
              <i class="material-icons">info</i>
              <span><span class="required">*</span> Campos obligatorios. Los demás campos pueden completarse después.</span>
            </div>

            <div class="form-actions">
              <button type="submit" id="btnPacGuardar">Registrar</button>
              <button type="button" id="btnPacCancelar" style="display: none">
                Cancelar
              </button>
            </div>
          </form>
        </section>
        <section id="paciente-list-section">
          <h2>Listado de Pacientes</h2>

          <div class="search-container">
            <input
              type="text"
              id="pacienteFilter"
              placeholder="Buscar paciente..." />
          </div>

          <table id="pacienteTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Cédula</th>
                <th>Tipo Examen</th>
                <th>Empresa</th>
                <th>Valor</th>
                <th>Consultorio</th>
                <th>Turno</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div id="noPacienteData" style="display: none">Sin resultados.</div>
        </section>
      </section>

      <!-- ====== TURNOS ====== -->
      <section id="turnos-view" class="view">
        <h1>Gestión de Turnos</h1>

        <!-- Selector de consultorio -->
        <section class="selector">
          <label>
            Consultorio
            <select id="turnoConsultorioSelect">
              <option value="">Seleccione...</option>
            </select>
          </label>
        </section>

        <!-- Panel visible cuando se selecciona un consultorio -->
        <section id="turnoPanel" class="panel" style="display: none">
          <!-- Turno actual -->
          <div class="turno-actual">
            <h2>Turno Actual</h2>
            <div class="numero" id="turnoActualNum">0</div>
            <div class="acciones">
              <button id="btnSiguiente">Siguiente Turno</button>
              <button id="btnReiniciar">Volver a Anunciar</button>
              <button id="btnTerminarJornada" class="btn-cerrar-jornada">
                Terminar Jornada
              </button>
            </div>
          </div>

          <!-- Pacientes en espera -->
          <div class="pacientes-espera">
            <h2>Pacientes en Espera</h2>
            <table id="tablaEspera">
              <thead>
                <tr>
                  <th>Turno</th>
                  <th>Nombre</th>
                  <th>Cédula</th>
                  <th>Tipo Examen</th>
                  <th>Hora Entrada</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="noEspera" style="display: none">
              Sin pacientes en espera
            </div>
          </div>
        </section>

        <!-- Mensaje cuando no hay consultorio seleccionado -->
        <div id="noConsultorio" class="no-consultorio">
          <p>Por favor, seleccione un consultorio para gestionar los turnos.</p>
        </div>
      </section>

      <!-- ====== Historial ====== -->
      <section id="historial-view" class="view">
        <h1>Historial de Pacientes</h1>

        <!-- Filtros -->
        <section class="filter-section">
          <div class="toggle-group">
            <button id="btnPendientes" class="toggle active">Pendientes</button>
            <button id="btnAtendidos" class="toggle">Atendidos</button>
          </div>

          <div class="date-filters">
            <label>
              Desde
              <input type="date" id="fechaDesde" />
            </label>
            <label>
              Hasta
              <input type="date" id="fechaHasta" />
            </label>
            <button id="btnFiltrarFechas">Filtrar</button>
            <button id="btnLimpiarFiltros">Limpiar</button>
          </div>

          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="Buscar en el historial..." />
          </div>

          <div class="export-actions">
            <button id="btnExportarExcel" class="export-btn">
              <i class="material-icons">file_download</i>
              Descargar Excel
            </button>
          </div>
        </section>

        <!-- Tabla -->
        <table id="historialTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Cédula</th>
              <th>Tipo Examen</th>
              <th>Empresa</th>
              <th>Valor</th>
              <th>Consultorio</th>
              <th>Turno</th>
              <th>Estado</th>
              <th>Hora Entrada</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div id="noResultados" style="display: none">Sin resultados</div>
      </section>

      <!-- ====== INFORMANTE ====== -->
      <section id="informante-view" class="view">
        <div class="informante-content">
          <div class="imagenes-slider">
            <img src="" alt="Promociones" class="slider-img" />
          </div>

          <div class="turnos-lista">
            <header class="informante-header">
              <h1 class="no-margin">Turnos Actuales</h1>
              <button
                id="toggleFullscreenBtn"
                class="fullscreen-toggle-btn"
                title="Alternar pantalla completa">
                <span class="material-icons">fullscreen</span>
              </button>
            </header>

            <!-- Turnos en horizontal -->
            <div class="turnos-vertical no-padding" id="turnosContainer">
              <!-- se llenará dinámicamente -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/eventBus.js"></script>
    <script src="js/webSocketManager.js"></script>
    <script src="js/consultorioService.js"></script>
    <script src="js/consultorioForm.js"></script>
    <script src="js/consultorioList.js"></script>

    <script src="js/pacienteService.js"></script>
    <script src="js/pacienteForm.js"></script>
    <script src="js/pacienteList.js"></script>

    <script src="js/turnoService.js"></script>
    <script src="js/turnosPage.js"></script>

    <script src="js/historialPage.js"></script>
    <script src="js/informantePage.js"></script>

    <script src="js/router.js"></script>

    <script>
      function showToast(msg) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
      }
    </script>
  </body>
</html>
